<html>
	<head>
		<link href="css/game.css" type="text/css" rel="stylesheet" />
	</head>

	<body>
		<canvas id="gameCanvas"></canvas>

		<script>
			var TO_RADIANS = Math.PI/180;
			var ROTATION_SPEED = 2;

			var canvas = document.getElementById("gameCanvas");
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			var context = canvas.getContext("2d");


			var sizeWidth = context.canvas.clientWidth;
			var sizeHeight = context.canvas.clientHeight;
			var aspectRatio = sizeWidth / sizeHeight;

			var rotation = 0;
			var activeKeys = [];

			var score = 0;

			var lastDrop = 0;
			var lastTime = 0;
			var blocks = [];

			var boxHeight = 0.1;
			var boxWidth = boxHeight / aspectRatio;

			var blockSpawnRate = 1500;
			var blockDropRate = 0.0002;

			var halfHeight = -boxHeight / 2 * sizeHeight;
			var seeSaw = 0.7;
			var pos = 0;
			var weight = 0;
			var baseRotation = 0;

			var getSeeSawHeight = function(x, rot) {
				return (seeSaw * sizeHeight) - (Math.tan((rot) * TO_RADIANS) * (sizeWidth / 2 - (x)));
			}

			var blockColliding = function(block) {
				var blockBottom = (block.y * sizeHeight) - halfHeight;

				for (var i = 0; i < blocks.length; i++) {
					if (blocks[i] !== block &&
						blocks[i].y > block.y &&
						Math.abs(blocks[i].x - block.x) <= boxWidth &&
						Math.abs(blocks[i].y - block.y) <= boxHeight)
						return blocks[i];
				}
				return (blockBottom >= getSeeSawHeight(block.x * sizeWidth, rotation)) ? "seesaw" : false;
			}

			var setRotation = function(rot) {
				baseRotation = rot;
				rot = rot + (weight * 100);
				if (rot > 30)
					rot = 30;
				else if (rot < -30)
					rot = -30;

				for (var i = 0; i < blocks.length; i++) {
					if (blocks[i].attachedBlock) {
						if (blocks[i].attachedBlock == "seesaw") {
							var newHeight = getSeeSawHeight(blocks[i].x * sizeWidth, rot);
							//if (newHeight < origHeight) {
								blocks[i].y = (newHeight / sizeHeight) - (boxHeight / 2);
							//}
						} else {
							blocks[i].y = blocks[i].attachedBlock.y - boxHeight;
						}
					}
				}
				rotation = rot;
			}

			var setWeight = function(w) {
				weight = w;
				setRotation(baseRotation);
			}

			var update = function() {
				var currentTime = new Date().getTime();
				var deltaTime = currentTime - lastTime;

				if (activeKeys[65]) {
					setRotation(baseRotation - ROTATION_SPEED);
				} else if (activeKeys[68]) {
					setRotation(baseRotation + ROTATION_SPEED);
				}

				if (currentTime - lastDrop > blockSpawnRate) {
					var x = (Math.random() * 0.45) + 0.225;
					blocks.push({ x: x, y: -0.2 });
					lastDrop = currentTime;
				}

				var move = false;
				for (var i = 0; i < blocks.length; i++ ) {
					if (!blocks[i].attachedBlock) {
						var collision = blockColliding(blocks[i]);
						if (!collision) {
							blocks[i].y = blocks[i].y + (blockDropRate * deltaTime);
						} else {
							blocks[i].attachedBlock = collision;
							if (blocks[i].y < 0.3) {
								move = true;
							}
							weight = weight - (0.5 - blocks[i].x);
						}
					}
				}
				setWeight(weight);


				if (move) {
					pos = pos + 0.01;
					document.getElementById('gameCanvas').style.backgroundPosition = "0 " + (100 - pos) + "%";
					seeSaw = seeSaw + 0.02;
				}
				draw();

				lastTime = currentTime;
			}

			var drawSeeSaw = function() {
				context.save();
				context.translate(.5 * sizeWidth, seeSaw * sizeHeight);
				context.rotate(rotation * TO_RADIANS);
				context.fillStyle = "#FF0000";
				context.fillRect(-.25 * sizeWidth,.0,.5 * sizeWidth,.01 * sizeHeight);
				context.restore();
			}

			var drawBlock = function(block) {
				context.save();
				context.translate(block.x * sizeWidth, block.y * sizeHeight);
				context.fillStyle = "#FF0000";
				context.fillRect(-.0125 * sizeWidth, (-boxHeight) / 2 * sizeHeight, boxWidth * sizeWidth, (boxHeight) * sizeHeight);
				context.restore();
			}

			var draw = function() {
				context.clearRect(0, 0, sizeWidth, sizeHeight);

				context.font = "14px serif";
  				context.fillText("Score: " + score, 10, 50);

				for (var i = 0; i < blocks.length; i++) {
					drawBlock(blocks[i]);
				}

				drawSeeSaw();
			}

			var tilt = function(x, y) {
				if (x === null) return;
				setRotation(x);
			}

			var keyDown = function(event) {
				activeKeys[event.which] = true;
			}

			var keyUp = function(event) {
				activeKeys[event.which] = false;
			}

			if (window.DeviceOrientationEvent) {
			    window.addEventListener("deviceorientation", function () {
			        tilt(event.beta, event.gamma);
			    }, true);
			} else if (window.DeviceMotionEvent) {
			    window.addEventListener('devicemotion', function () {
			        tilt(event.acceleration.x * 2, event.acceleration.y * 2);
			    }, true);
			} else {
			    window.addEventListener("MozOrientation", function () {
			        tilt(orientation.x * 50, orientation.y * 50);
			    }, true);
			}

			window.addEventListener("keydown", keyDown);
			window.addEventListener("keyup", keyUp);
			setInterval(update, 50);
		</script>
	</body>
</html>
